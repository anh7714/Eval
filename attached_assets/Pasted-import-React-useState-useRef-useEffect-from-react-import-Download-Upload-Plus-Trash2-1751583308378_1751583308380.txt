import React, { useState, useRef, useEffect } from 'react';
import { Download, Upload, Plus, Trash2, Edit3, Save, X, Printer } from 'lucide-react';

const EvaluationSystem = () => {
  // ì»¬ëŸ¼ ì„¤ì • ê´€ë¦¬
  const [columnConfig, setColumnConfig] = useState([
    { id: 'section', title: 'êµ¬ë¶„', type: 'section', visible: true, required: true, width: 'w-32' },
    { id: 'item', title: 'ì„¸ë¶€ í•­ëª©', type: 'text', visible: true, required: true, width: 'flex-1' },
    { id: 'type', title: 'ìœ í˜•', type: 'select', visible: true, required: false, width: 'w-16', options: ['ì •ëŸ‰', 'ì •ì„±'] },
    { id: 'points', title: 'ë°°ì ', type: 'number', visible: true, required: true, width: 'w-16' },
    { id: 'score', title: 'í‰ê°€ì ìˆ˜', type: 'number', visible: true, required: true, width: 'w-20' },
  ]);

  // í‰ê°€ìœ„ì› ì •ë³´ (ì‹¤ì œ êµ¬í˜„ì‹œ ì™¸ë¶€ APIë‚˜ ì „ì—­ ìƒíƒœì—ì„œ ê°€ì ¸ì˜¬ ë°ì´í„°)
  const [evaluator, setEvaluator] = useState({
    name: '', // ì‹¤ì œë¡œëŠ” ì™¸ë¶€ì—ì„œ ê°€ì ¸ì˜¬ í‰ê°€ìœ„ì› ì´ë¦„
    position: '', // í‰ê°€ìœ„ì› ì§ì±…
    department: '' // í‰ê°€ìœ„ì› ì†Œì†
  });

  // í‰ê°€ìœ„ì› ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (ì‹¤ì œ êµ¬í˜„ì‹œ useEffectë¡œ ì™¸ë¶€ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
  useEffect(() => {
    // ì‹¤ì œ êµ¬í˜„ì‹œì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì™¸ë¶€ì—ì„œ í‰ê°€ìœ„ì› ì •ë³´ë¥¼ ê°€ì ¸ì˜´
    // fetchEvaluatorInfo().then(data => setEvaluator(data));
    
    // ì„ì‹œë¡œ ë¹ˆ ìƒíƒœë¡œ ì„¤ì • (ì‹¤ì œ êµ¬í˜„ì‹œ ì œê±°)
    setEvaluator({
      name: 'í‰ê°€ìœ„ì›ëª…', // ì‹¤ì œ êµ¬í˜„ì‹œ ì™¸ë¶€ì—ì„œ ê°€ì ¸ì˜¬ ë°ì´í„°
      position: 'ì§ì±…',
      department: 'ì†Œì†ê¸°ê´€'
    });
  }, []);

  // ì»¬ëŸ¼ ì„¤ì • ë³€ê²½ ì‹œ ê¸°ì¡´ ë°ì´í„° ë™ê¸°í™”
  useEffect(() => {
    setCurrentTemplate(prev => ({
      ...prev,
      sections: prev.sections.map(section => ({
        ...section,
        items: section.items.map(item => {
          const updatedItem = { ...item };
          columnConfig.forEach(column => {
            if (!['section', 'item', 'type', 'points', 'score'].includes(column.id)) {
              if (!(column.id in updatedItem)) {
                updatedItem[column.id] = column.type === 'number' ? 0 : '';
              }
            }
          });
          return updatedItem;
        })
      }))
    }));
  }, [columnConfig]);

  const [currentTemplate, setCurrentTemplate] = useState({
    title: "ì œê³µê¸°ê´€ ì„ ì • ì‹¬ì˜íšŒ í‰ê°€í‘œ",
    totalScore: 100,
    sections: [
      {
        id: 'A',
        title: 'ê¸°ê´€ìˆ˜í–‰ëŠ¥ë ¥',
        totalPoints: 35,
        items: [
          { id: 1, text: 'í†µê³„SOS ì‚¬ì—… ìš´ì˜ ì²´ê³„í™” 2ë‹¨ ì™„ë£Œ', type: 'ì •ì„±', points: 20, score: 0 },
          { id: 2, text: 'ì‹¬ì˜ ë° ìŠ¹ì¸ ëª©ì  í™•ì¸', type: 'ì •ëŸ‰', points: 5, score: 0 },
          { id: 3, text: 'ê¸°ê´€ ìš´ì˜ ê¸°ê°„', type: 'ì •ì„±', points: 5, score: 0 },
          { id: 4, text: 'ì¡°ì§êµ¬ì„±', type: 'ì •ëŸ‰', points: 5, score: 0 }
        ]
      },
      {
        id: 'B',
        title: 'ì¸ë ¥ìš´ì˜',
        totalPoints: 20,
        items: [
          { id: 1, text: 'ì‚¬ì—… ìš´ì˜ ì´ê´„ì ë° ë‹´ë‹¹ìì˜ ì „ë¬¸ì„±', type: 'ì •ì„±', points: 5, score: 0 },
          { id: 2, text: 'í†µê³„SOS ì‚¬ì—… ìš´ì˜ ì²´ê³„í™”ë¶€ ë‹´ë‹¹ì', type: 'ì •ëŸ‰', points: 5, score: 0 },
          { id: 3, text: 'SOSì„œë¹„ìŠ¤ ìˆ˜í–‰ ì¸ë ¥ì˜ í™•ë³´', type: 'ì •ëŸ‰', points: 10, score: 0 }
        ]
      },
      {
        id: 'C',
        title: 'ì¸ê±´ë¹„ê´€ë¦¬',
        totalPoints: 10,
        items: [
          { id: 1, text: 'ì„¸ë¶€ì‚¬ì—…ë³„ í”„ë¡œê·¸ë¨ (ì´ìš©ìí›„ê¸°ì‹œ)', type: 'ì •ëŸ‰', points: 5, score: 0 },
          { id: 2, text: 'ì£¼ìš” ì‚¬ê³  ì˜ˆë°© ëŒ€ì±… ê´€ë¦¬ ë° ì´ìš©ì ì¬ì´ìš©ê´€ë¦¬', type: 'ì •ëŸ‰', points: 5, score: 0 }
        ]
      },
      {
        id: 'D',
        title: 'ê³µëª¨ì°¸ì—¬',
        totalPoints: 15,
        items: [
          { id: 1, text: 'ì‚¬ì—…(ì´ê´„) ëª…ê°€ ê²°ê³¼', type: 'ì •ëŸ‰', points: 15, score: 0 }
        ]
      },
      {
        id: 'E',
        title: 'ì‹¤ì í‰ê°€',
        totalPoints: 20,
        items: [
          { id: 1, text: 'ì„œë¹„ìŠ¤ ì œê³µ ê±´ìˆ˜(í•™ì—… ê¸°ê°„)', type: 'ì •ëŸ‰', points: 15, score: 0 },
          { id: 2, text: 'ì„¸ê¸ˆê¸°ì—… ëª…ê°€ê²°ê³¼ ê²°ê³¼ (í†µê³„ë°°ë„ˆì‹œ)', type: 'ì •ëŸ‰', points: 5, score: 0 }
        ]
      }
    ]
  });

  const [isEditing, setIsEditing] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const fileInputRef = useRef(null);

  const calculateSectionScore = (section) => {
    return section.items.reduce((sum, item) => sum + (item.score || 0), 0);
  };

  const calculateSectionTotalPoints = (section) => {
    return section.items.reduce((sum, item) => sum + (item.points || 0), 0);
  };

  const calculateTotalPoints = () => {
    return currentTemplate.sections.reduce((sum, section) => sum + calculateSectionTotalPoints(section), 0);
  };

  const calculateTotalScore = () => {
    return currentTemplate.sections.reduce((sum, section) => sum + calculateSectionScore(section), 0);
  };

  const updateScore = (sectionId, itemId, score) => {
    setCurrentTemplate(prev => ({
      ...prev,
      sections: prev.sections.map(section =>
        section.id === sectionId
          ? {
              ...section,
              items: section.items.map(item =>
                item.id === itemId ? { ...item, score: Math.min(score, item.points) } : item
              )
            }
          : section
      )
    }));
  };

  const addSection = () => {
    const newId = String.fromCharCode(65 + currentTemplate.sections.length);
    
    // ìƒˆ í•­ëª©ì— ëª¨ë“  ì»¬ëŸ¼ í•„ë“œ ì¶”ê°€
    const newItem = {
      id: 1,
      text: 'ìƒˆ í‰ê°€í•­ëª©',
      type: 'ì •ëŸ‰',
      points: 10,
      score: 0
    };
    
    // ì»¤ìŠ¤í…€ ì»¬ëŸ¼ë“¤ì— ëŒ€í•œ ë¹ˆ ê°’ ì¶”ê°€
    columnConfig.forEach(column => {
      if (!['section', 'item', 'type', 'points', 'score'].includes(column.id)) {
        newItem[column.id] = column.type === 'number' ? 0 : '';
      }
    });
    
    setCurrentTemplate(prev => ({
      ...prev,
      sections: [...prev.sections, {
        id: newId,
        title: 'ìƒˆ í‰ê°€ì˜ì—­',
        totalPoints: 10,
        items: [newItem]
      }]
    }));
  };

  const deleteSection = (sectionId) => {
    setCurrentTemplate(prev => ({
      ...prev,
      sections: prev.sections.filter(section => section.id !== sectionId)
    }));
  };

  const addItem = (sectionId) => {
    // ìƒˆ í•­ëª©ì— ëª¨ë“  ì»¬ëŸ¼ í•„ë“œ ì¶”ê°€
    const newItem = {
      id: Math.max(...currentTemplate.sections.find(s => s.id === sectionId).items.map(i => i.id)) + 1,
      text: 'ìƒˆ í‰ê°€í•­ëª©',
      type: 'ì •ëŸ‰',
      points: 5,
      score: 0
    };
    
    // ì»¤ìŠ¤í…€ ì»¬ëŸ¼ë“¤ì— ëŒ€í•œ ë¹ˆ ê°’ ì¶”ê°€
    columnConfig.forEach(column => {
      if (!['section', 'item', 'type', 'points', 'score'].includes(column.id)) {
        newItem[column.id] = column.type === 'number' ? 0 : '';
      }
    });
    
    setCurrentTemplate(prev => ({
      ...prev,
      sections: prev.sections.map(section =>
        section.id === sectionId
          ? {
              ...section,
              items: [...section.items, newItem]
            }
          : section
      )
    }));
  };

  const deleteItem = (sectionId, itemId) => {
    setCurrentTemplate(prev => ({
      ...prev,
      sections: prev.sections.map(section =>
        section.id === sectionId
          ? {
              ...section,
              items: section.items.filter(item => item.id !== itemId)
            }
          : section
      )
    }));
  };

  const updateItem = (sectionId, itemId, field, value) => {
    setCurrentTemplate(prev => ({
      ...prev,
      sections: prev.sections.map(section =>
        section.id === sectionId
          ? {
              ...section,
              items: section.items.map(item =>
                item.id === itemId ? { ...item, [field]: value } : item
              )
            }
          : section
      )
    }));
  };

  // ë³´ì´ëŠ” ì»¬ëŸ¼ë“¤ë§Œ í•„í„°ë§
  const visibleColumns = columnConfig.filter(col => col.visible);

  const updateSection = (sectionId, field, value) => {
    setCurrentTemplate(prev => ({
      ...prev,
      sections: prev.sections.map(section =>
        section.id === sectionId ? { ...section, [field]: value } : section
      )
    }));
  };

  const saveTemplate = () => {
    // í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ìœ¼ë¡œ íŒŒì¼ëª… ìƒì„±
    const now = new Date();
    const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
    const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
    const fileName = `í‰ê°€í‘œ_${currentTemplate.title.replace(/[^\w\s]/gi, '')}_${dateStr}_${timeStr}.json`;
    
    // í‰ê°€ìœ„ì› ì •ë³´ì™€ ì»¬ëŸ¼ ì„¤ì •ë„ í¬í•¨í•´ì„œ ì €ì¥
    const templateWithAll = {
      ...currentTemplate,
      evaluator: evaluator,
      columnConfig: columnConfig
    };
    
    const dataStr = JSON.stringify(templateWithAll, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', fileName);
    linkElement.click();
    
    // ì‚¬ìš©ìì—ê²Œ ì €ì¥ ì™„ë£Œ ì•Œë¦¼
    const notification = document.createElement('div');
    notification.textContent = 'âœ… í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    document.body.appendChild(notification);
    
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 3000);
  };

  const loadTemplate = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const template = JSON.parse(e.target.result);
          
          // í…œí”Œë¦¿ ìœ íš¨ì„± ê²€ì‚¬
          if (!template.title || !template.sections || !Array.isArray(template.sections)) {
            throw new Error('ì˜¬ë°”ë¥´ì§€ ì•Šì€ í…œí”Œë¦¿ í˜•ì‹ì…ë‹ˆë‹¤.');
          }
          
          // í‰ê°€ìœ„ì› ì •ë³´ê°€ ìˆìœ¼ë©´ ê°™ì´ ë¶ˆëŸ¬ì˜¤ê¸°
          if (template.evaluator) {
            setEvaluator(template.evaluator);
          }
          
          // ì»¬ëŸ¼ ì„¤ì •ì´ ìˆìœ¼ë©´ ê°™ì´ ë¶ˆëŸ¬ì˜¤ê¸°
          if (template.columnConfig) {
            setColumnConfig(template.columnConfig);
          }
          
          setCurrentTemplate(template);
          
          // ì„±ê³µ ì•Œë¦¼
          const notification = document.createElement('div');
          notification.textContent = 'âœ… í…œí”Œë¦¿ì´ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!';
          notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
          document.body.appendChild(notification);
          
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 3000);
          
        } catch (error) {
          // ì—ëŸ¬ ì•Œë¦¼
          const notification = document.createElement('div');
          notification.textContent = 'âŒ ' + error.message;
          notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
          document.body.appendChild(notification);
          
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 3000);
        }
      };
      reader.readAsText(file);
    }
    
    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥)
    event.target.value = '';
  };

  const printResults = () => {
    // ì¸ì‡„ ìŠ¤íƒ€ì¼ ì¶”ê°€
    const printStyle = `
      <style>
        @media print {
          .print\\:hidden { display: none !important; }
          .print\\:block { display: block !important; }
          .print\\:mb-4 { margin-bottom: 1rem !important; }
          .print\\:text-center { text-align: center !important; }
          .print\\:text-4xl { font-size: 2.25rem !important; }
          .print\\:font-black { font-weight: 900 !important; }
          .print\\:text-black { color: black !important; }
          .print\\:border-none { border: none !important; }
          
          body { 
            font-size: 12px !important; 
            line-height: 1.4 !important;
            margin: 0 !important;
            padding: 20px !important;
          }
          
          table { 
            page-break-inside: avoid; 
            width: 100% !important;
            border-collapse: collapse !important;
          }
          
          tr { 
            page-break-inside: avoid; 
          }
          
          .bg-blue-50 { 
            background-color: #eff6ff !important; 
            -webkit-print-color-adjust: exact !important;
          }
          
          .bg-gray-100 { 
            background-color: #f3f4f6 !important; 
            -webkit-print-color-adjust: exact !important;
          }
          
          .border { 
            border: 1px solid #000 !important; 
          }
          
          .border-black {
            border-color: black !important;
          }
          
          /* ì œëª© ìŠ¤íƒ€ì¼ */
          .max-w-6xl {
            max-width: 100% !important;
            margin: 0 !important;
          }
          
          /* í‰ê°€ìœ„ì› ì„œëª…ë€ ìŠ¤íƒ€ì¼ */
          .mt-12 {
            margin-top: 3rem !important;
          }
          
          .border-t {
            border-top: 2px solid #000 !important;
          }
          
          .pt-8 {
            padding-top: 2rem !important;
          }
        }
      </style>
    `;
    
    // ê¸°ì¡´ headì— ìŠ¤íƒ€ì¼ ì¶”ê°€
    const head = document.head;
    const styleElement = document.createElement('div');
    styleElement.innerHTML = printStyle;
    head.appendChild(styleElement.firstChild);
    
    // ì¸ì‡„ ì‹¤í–‰
    window.print();
    
    // ìŠ¤íƒ€ì¼ ì œê±° (ì¸ì‡„ í›„)
    setTimeout(() => {
      head.removeChild(head.lastChild);
    }, 1000);
  };

  const resetScores = () => {
    setCurrentTemplate(prev => ({
      ...prev,
      sections: prev.sections.map(section => ({
        ...section,
        items: section.items.map(item => ({ ...item, score: 0 }))
      }))
    }));
  };

  return (
    <div className="max-w-6xl mx-auto p-6 bg-gray-50 min-h-screen">
      <div className="bg-white rounded-lg shadow-lg p-8">
        {/* í—¤ë” */}
        <div className="flex justify-between items-center mb-8 print:mb-4">
          <div className="flex-1 text-center print:text-center">
            <input
              type="text"
              value={currentTemplate.title}
              onChange={(e) => setCurrentTemplate(prev => ({ ...prev, title: e.target.value }))}
              className="text-3xl font-bold text-gray-800 bg-transparent border-b-2 border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none transition-colors text-center w-full print:text-4xl print:font-black print:text-black print:border-none"
              disabled={!isEditing}
            />
          </div>
          
          <div className="flex gap-2 print:hidden">
            <button
              onClick={() => setIsEditing(!isEditing)}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                isEditing 
                  ? 'bg-green-600 text-white hover:bg-green-700' 
                  : 'bg-blue-600 text-white hover:bg-blue-700'
              }`}
            >
              {isEditing ? <Save size={18} /> : <Edit3 size={18} />}
            </button>
            
            <button
              onClick={saveTemplate}
              className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
              title="í…œí”Œë¦¿ ì €ì¥"
            >
              <Download size={18} />
            </button>
            
            <button
              onClick={() => fileInputRef.current?.click()}
              className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors"
              title="í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°"
            >
              <Upload size={18} />
            </button>
            
            <button
              onClick={printResults}
              className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
              title="ì¸ì‡„"
            >
              <Printer size={18} />
            </button>
            
            <button
              onClick={resetScores}
              className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
              title="ì ìˆ˜ ì´ˆê¸°í™”"
            >
              <X size={18} />
            </button>
          </div>
        </div>

        {/* ì»¬ëŸ¼ ì„¤ì • íŒ¨ë„ (í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ) */}
        {isEditing && (
          <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200 print:hidden">
            <h3 className="text-lg font-semibold mb-3 text-blue-800">ì»¬ëŸ¼ ì„¤ì •</h3>
            <div className="space-y-3">
              <div className="space-y-3">
                {columnConfig.map((column) => (
                  <div key={column.id} className="p-3 bg-white rounded-lg border">
                    <div className="flex items-center space-x-2 mb-2">
                      <input
                        type="checkbox"
                        checked={column.visible}
                        onChange={(e) => updateColumnConfig(column.id, 'visible', e.target.checked)}
                        className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        disabled={column.required}
                      />
                      <input
                        type="text"
                        value={column.title}
                        onChange={(e) => updateColumnConfig(column.id, 'title', e.target.value)}
                        className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:border-blue-500 focus:outline-none"
                        placeholder="ì»¬ëŸ¼ ì œëª©"
                      />
                      <select
                        value={column.type}
                        onChange={(e) => updateColumnConfig(column.id, 'type', e.target.value)}
                        className="px-2 py-1 border border-gray-300 rounded text-sm focus:border-blue-500 focus:outline-none"
                      >
                        <option value="text">í…ìŠ¤íŠ¸</option>
                        <option value="number">ìˆ«ì</option>
                        <option value="select">ì„ íƒ</option>
                      </select>
                      {!column.required && (
                        <button
                          onClick={() => deleteColumn(column.id)}
                          className="text-red-600 hover:text-red-800 text-sm"
                          title="ì»¬ëŸ¼ ì‚­ì œ"
                        >
                          <Trash2 size={16} />
                        </button>
                      )}
                      {column.required && (
                        <span className="text-xs text-gray-500 px-2">í•„ìˆ˜</span>
                      )}
                    </div>
                    
                    {column.type === 'select' && (
                      <div className="flex items-center space-x-2">
                        <span className="text-sm text-gray-600">ì„ íƒì˜µì…˜:</span>
                        <input
                          type="text"
                          value={column.options?.join(', ') || ''}
                          onChange={(e) => updateColumnConfig(column.id, 'options', e.target.value.split(',').map(s => s.trim()).filter(s => s))}
                          className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:border-blue-500 focus:outline-none"
                          placeholder="ì˜µì…˜1, ì˜µì…˜2, ì˜µì…˜3 (ì½¤ë§ˆë¡œ êµ¬ë¶„)"
                        />
                      </div>
                    )}
                  </div>
                ))}
              </div>
              <div className="flex justify-between items-center">
                <button
                  onClick={addColumn}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center gap-2"
                >
                  <Plus size={16} />
                  ìƒˆ ì»¬ëŸ¼ ì¶”ê°€
                </button>
                <div className="text-sm text-gray-600">
                  ğŸ’¡ ì²´í¬ë°•ìŠ¤ë¡œ ì»¬ëŸ¼ í‘œì‹œ/ìˆ¨ê¹€ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•„ìˆ˜ ì»¬ëŸ¼ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                </div>
              </div>
            </div>
          </div>
        )}

        {/* í‰ê°€ìœ„ì› ì •ë³´ ì„¤ì • (í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ) */}
        {isEditing && (
          <div className="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200 print:hidden">
            <h3 className="text-lg font-semibold mb-3 text-yellow-800">í‰ê°€ìœ„ì› ì •ë³´ ì„¤ì •</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">í‰ê°€ìœ„ì›ëª…</label>
                <input
                  type="text"
                  value={evaluator.name}
                  onChange={(e) => setEvaluator(prev => ({ ...prev, name: e.target.value }))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  placeholder="í‰ê°€ìœ„ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ì§ì±…</label>
                <input
                  type="text"
                  value={evaluator.position}
                  onChange={(e) => setEvaluator(prev => ({ ...prev, position: e.target.value }))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  placeholder="ì§ì±…ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ì†Œì†ê¸°ê´€</label>
                <input
                  type="text"
                  value={evaluator.department}
                  onChange={(e) => setEvaluator(prev => ({ ...prev, department: e.target.value }))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  placeholder="ì†Œì†ê¸°ê´€ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>
            </div>
            <div className="mt-2 text-sm text-gray-600">
              ğŸ’¡ ì‹¤ì œ êµ¬í˜„ì‹œì—ëŠ” ì™¸ë¶€ ì‹œìŠ¤í…œì—ì„œ í‰ê°€ìœ„ì› ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
          </div>
        )}

        <input
          type="file"
          ref={fileInputRef}
          onChange={loadTemplate}
          accept=".json"
          className="hidden"
        />

        {/* í‰ê°€í‘œ */}
        <div className="overflow-x-auto">
          <table className="w-full border-collapse border border-gray-400 text-sm">
            <thead>
              <tr className="bg-gray-100">
                {visibleColumns.map((column) => (
                  <th 
                    key={column.id} 
                    className={`border border-gray-400 px-4 py-3 text-center font-bold ${
                      column.id === 'section' ? 'w-32' : 
                      column.id === 'item' ? '' : 
                      column.width || 'w-20'
                    }`}
                  >
                    {column.title}
                    {column.id === 'section' && ` (${calculateTotalPoints()}ì )`}
                  </th>
                ))}
                {isEditing && <th className="border border-gray-400 px-2 py-3 text-center font-bold w-20 print:hidden">ê´€ë¦¬</th>}
              </tr>
            </thead>
            <tbody>
              {currentTemplate.sections.map((section, sectionIndex) => (
                <React.Fragment key={section.id}>
                  {section.items.map((item, itemIndex) => (
                    <tr key={`${section.id}-${item.id}`} className="hover:bg-gray-50">
                      {visibleColumns.map((column) => {
                        if (column.id === 'section' && itemIndex === 0) {
                          return (
                            <td 
                              key={column.id}
                              className="border border-gray-400 px-4 py-3 font-medium bg-blue-50 align-top text-center"
                              rowSpan={section.items.length}
                            >
                              <div className="flex flex-col items-center justify-center">
                                <div className="text-center">
                                  {isEditing ? (
                                    <input
                                      type="text"
                                      value={section.title}
                                      onChange={(e) => updateSection(section.id, 'title', e.target.value)}
                                      className="font-bold text-sm bg-transparent border-b border-gray-300 focus:border-blue-500 focus:outline-none text-center"
                                    />
                                  ) : (
                                    <span className="font-bold text-sm">{section.id}. {section.title}</span>
                                  )}
                                  <div className="text-xs text-gray-600 mt-1">
                                    ({calculateSectionTotalPoints(section)}ì )
                                  </div>
                                </div>
                                {isEditing && (
                                  <div className="flex flex-col gap-1 mt-2 print:hidden">
                                    <button
                                      onClick={() => addItem(section.id)}
                                      className="text-blue-600 hover:text-blue-800 text-xs"
                                      title="í•­ëª© ì¶”ê°€"
                                    >
                                      <Plus size={14} />
                                    </button>
                                    <button
                                      onClick={() => deleteSection(section.id)}
                                      className="text-red-600 hover:text-red-800 text-xs"
                                      title="ì„¹ì…˜ ì‚­ì œ"
                                    >
                                      <Trash2 size={14} />
                                    </button>
                                  </div>
                                )}
                              </div>
                            </td>
                          );
                        } else if (column.id === 'section' && itemIndex > 0) {
                          return null; // ì„¹ì…˜ ì»¬ëŸ¼ì€ ì²« ë²ˆì§¸ í–‰ì—ì„œë§Œ ë Œë”ë§
                        } else if (column.id === 'item') {
                          return (
                            <td key={column.id} className="border border-gray-400 px-4 py-3">
                              {isEditing ? (
                                <input
                                  type="text"
                                  value={item.text}
                                  onChange={(e) => updateItem(section.id, item.id, 'text', e.target.value)}
                                  className="w-full bg-transparent border-b border-gray-300 focus:border-blue-500 focus:outline-none text-sm"
                                />
                              ) : (
                                <span className="text-sm">{item.id}. {item.text}</span>
                              )}
                            </td>
                          );
                        } else if (column.id === 'type') {
                          return (
                            <td key={column.id} className="border border-gray-400 px-2 py-3 text-center">
                              {isEditing ? (
                                <select
                                  value={item.type || 'ì •ëŸ‰'}
                                  onChange={(e) => updateItem(section.id, item.id, 'type', e.target.value)}
                                  className="w-full text-xs bg-transparent border border-gray-300 rounded focus:border-blue-500 focus:outline-none"
                                >
                                  <option value="ì •ëŸ‰">ì •ëŸ‰</option>
                                  <option value="ì •ì„±">ì •ì„±</option>
                                </select>
                              ) : (
                                <span className="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">
                                  {item.type || 'ì •ëŸ‰'}
                                </span>
                              )}
                            </td>
                          );
                        } else if (column.id === 'points') {
                          return (
                            <td key={column.id} className="border border-gray-400 px-2 py-3 text-center">
                              {isEditing ? (
                                <input
                                  type="number"
                                  value={item.points}
                                  onChange={(e) => updateItem(section.id, item.id, 'points', parseInt(e.target.value) || 0)}
                                  className="w-full text-center text-sm bg-transparent border border-gray-300 rounded focus:border-blue-500 focus:outline-none"
                                  min="0"
                                />
                              ) : (
                                <span className="text-sm font-medium">{item.points}ì </span>
                              )}
                            </td>
                          );
                        } else if (column.id === 'score') {
                          return (
                            <td key={column.id} className="border border-gray-400 px-2 py-3 text-center">
                              <input
                                type="number"
                                value={item.score || 0}
                                onChange={(e) => updateScore(section.id, item.id, parseInt(e.target.value) || 0)}
                                className="w-full text-center text-sm border border-gray-300 rounded focus:border-blue-500 focus:outline-none"
                                min="0"
                                max={item.points}
                              />
                            </td>
                          );
                        } else {
                          // ì»¤ìŠ¤í…€ ì»¬ëŸ¼ ì²˜ë¦¬
                          return (
                            <td key={column.id} className="border border-gray-400 px-2 py-3 text-center">
                              {column.type === 'select' ? (
                                <select
                                  value={item[column.id] || ''}
                                  onChange={(e) => updateItem(section.id, item.id, column.id, e.target.value)}
                                  className="w-full text-xs bg-transparent border border-gray-300 rounded focus:border-blue-500 focus:outline-none"
                                >
                                  <option value="">ì„ íƒ</option>
                                  {column.options?.map(option => (
                                    <option key={option} value={option}>{option}</option>
                                  ))}
                                </select>
                              ) : column.type === 'number' ? (
                                <input
                                  type="number"
                                  value={item[column.id] || 0}
                                  onChange={(e) => updateItem(section.id, item.id, column.id, parseInt(e.target.value) || 0)}
                                  className="w-full text-center text-sm bg-transparent border border-gray-300 rounded focus:border-blue-500 focus:outline-none"
                                />
                              ) : (
                                <input
                                  type="text"
                                  value={item[column.id] || ''}
                                  onChange={(e) => updateItem(section.id, item.id, column.id, e.target.value)}
                                  className="w-full text-center text-sm bg-transparent border border-gray-300 rounded focus:border-blue-500 focus:outline-none"
                                />
                              )}
                            </td>
                          );
                        }
                      })}
                      
                      {isEditing && (
                        <td className="border border-gray-400 px-2 py-3 text-center print:hidden">
                          <button
                            onClick={() => deleteItem(section.id, item.id)}
                            className="text-red-600 hover:text-red-800"
                            title="í•­ëª© ì‚­ì œ"
                          >
                            <Trash2 size={14} />
                          </button>
                        </td>
                      )}
                    </tr>
                  ))}
                </React.Fragment>
              ))}
              
              {/* í•©ê³„ í–‰ */}
              <tr className="bg-blue-50 font-bold">
                {visibleColumns.map((column) => {
                  if (column.id === 'section') {
                    return (
                      <td key={column.id} className="border border-gray-400 px-4 py-3 text-center">
                        ì´ì 
                      </td>
                    );
                  } else if (column.id === 'item') {
                    return (
                      <td key={column.id} className="border border-gray-400 px-4 py-3"></td>
                    );
                  } else if (column.id === 'points') {
                    return (
                      <td key={column.id} className="border border-gray-400 px-2 py-3 text-center">
                        {calculateTotalPoints()}ì 
                      </td>
                    );
                  } else if (column.id === 'score') {
                    return (
                      <td key={column.id} className="border border-gray-400 px-2 py-3 text-center text-lg">
                        {calculateTotalScore()}ì 
                      </td>
                    );
                  } else {
                    return (
                      <td key={column.id} className="border border-gray-400 px-2 py-3"></td>
                    );
                  }
                })}
                {isEditing && <td className="border border-gray-400 px-2 py-3 print:hidden"></td>}
              </tr>
            </tbody>
          </table>
        </div>

        {/* ì„¹ì…˜ ì¶”ê°€ ë²„íŠ¼ */}
        {isEditing && (
          <div className="mt-6 print:hidden">
            <button
              onClick={addSection}
              className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center gap-2"
            >
              <Plus size={18} />
              ìƒˆ í‰ê°€ì˜ì—­ ì¶”ê°€
            </button>
          </div>
        )}

        {/* ì¸ì‡„ìš© í‰ê°€ìœ„ì› ì„œëª…ë€ */}
        <div className="hidden print:block mt-12 border-t pt-8">
          <div className="flex justify-end">
            <div className="text-right">
              <div className="mb-4">
                <span className="text-lg font-bold">í‰ê°€ìœ„ì›: </span>
                <span className="inline-block w-32 border-b border-black ml-2 pb-1 text-center">
                  {evaluator.name}
                </span>
                <span className="ml-2 text-sm">({evaluator.position})</span>
              </div>
              <div className="mb-4">
                <span className="text-lg font-bold">ì†Œì†ê¸°ê´€: </span>
                <span className="inline-block w-40 border-b border-black ml-2 pb-1 text-center">
                  {evaluator.department}
                </span>
              </div>
              <div className="mb-4">
                <span className="text-lg font-bold">ì„œëª…: </span>
                <span className="inline-block w-32 border-b border-black ml-2 pb-1"></span>
              </div>
              <div className="text-sm text-gray-600">
                í‰ê°€ì¼: {new Date().toLocaleDateString('ko-KR')}
              </div>
            </div>
          </div>
        </div>

        {/* ê²°ê³¼ ìš”ì•½ */}
        <div className="mt-8 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
          <h3 className="text-lg font-bold mb-4 text-gray-800">í‰ê°€ ê²°ê³¼ ìš”ì•½</h3>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-white p-4 rounded-lg text-center">
              <div className="text-2xl font-bold text-blue-600">
                {calculateTotalScore()}ì 
              </div>
              <div className="text-sm text-gray-600">ì´ì </div>
            </div>
            <div className="bg-white p-4 rounded-lg text-center">
              <div className="text-2xl font-bold text-green-600">
                {calculateTotalPoints() > 0 ? Math.round((calculateTotalScore() / calculateTotalPoints()) * 100) : 0}%
              </div>
              <div className="text-sm text-gray-600">ë‹¬ì„±ë¥ </div>
            </div>
            <div className="bg-white p-4 rounded-lg text-center">
              <div className="text-2xl font-bold text-purple-600">
                {currentTemplate.sections.length}ê°œ
              </div>
              <div className="text-sm text-gray-600">í‰ê°€ì˜ì—­</div>
            </div>
            <div className="bg-white p-4 rounded-lg text-center">
              <div className="text-2xl font-bold text-orange-600">
                {currentTemplate.sections.reduce((sum, section) => sum + section.items.length, 0)}ê°œ
              </div>
              <div className="text-sm text-gray-600">í‰ê°€í•­ëª©</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default EvaluationSystem;